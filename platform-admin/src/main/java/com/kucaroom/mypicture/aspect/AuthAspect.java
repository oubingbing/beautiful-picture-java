package com.kucaroom.mypicture.aspect;import com.kucaroom.mypicture.DTO.AdminDTO;import com.kucaroom.mypicture.DTO.WeChatAppDTO;import com.kucaroom.mypicture.domain.Admin;import com.kucaroom.mypicture.enums.ResponseEnum;import com.kucaroom.mypicture.exception.WebApiException;import com.kucaroom.mypicture.service.AdminService;import com.kucaroom.mypicture.service.AuthService;import com.kucaroom.mypicture.service.WeChatAppService;import lombok.extern.slf4j.Slf4j;import org.apache.shiro.SecurityUtils;import org.aspectj.lang.annotation.*;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import org.springframework.util.StringUtils;import org.springframework.web.context.request.RequestContextHolder;import org.springframework.web.context.request.ServletRequestAttributes;import org.springframework.web.servlet.ModelAndView;import org.springframework.web.servlet.support.RequestContext;import javax.servlet.http.HttpServletRequest;@Slf4j@Aspect@Componentpublic class AuthAspect {    @Autowired    private AuthService authService;    @Autowired    private AdminService adminService;    @Autowired    private WeChatAppService weChatAppService;    /**     * 拦截具体控制器下的所有方法     */    @Pointcut("execution(public * com.kucaroom.mypicture.controller.checkAuth.*.*(..))")    public void init(){    }    @Before("init()")    public void auth(){        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();        HttpServletRequest httpServletRequest = attributes.getRequest();        String classPath = httpServletRequest.getServletPath();        HttpServletRequest request = attributes.getRequest();        String email = (String) SecurityUtils.getSubject().getPrincipal();        AdminDTO admin = adminService.findByEmail(email);        if(admin != null){            WeChatAppDTO weChatAppDTO = weChatAppService.findByAdminId(admin.getId());            if(weChatAppDTO == null && !classPath.equals("/admin/app/create")){                throw new WebApiException(ResponseEnum.APP_NOT_EXIST);            }            if(weChatAppDTO != null){                request.setAttribute("appId",weChatAppDTO.getId());            }            request.setAttribute("email",email);            request.setAttribute("adminId",admin.getId());            request.setAttribute("username",admin.getUsername());        }    }    @After("init()")    public void response(){    }    /**     * 获取返回的数据对象     * @param object     */    @AfterReturning(returning = "object",pointcut = "init()")    public void responseData(Object object){    }}