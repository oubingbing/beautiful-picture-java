package com.kucaroom.mypicture.controller.checkAuth;import com.kucaroom.mypicture.DTO.QiNiuAccountDTO;import com.kucaroom.mypicture.DTO.WeChatAppDTO;import com.kucaroom.mypicture.enums.ResponseEnum;import com.kucaroom.mypicture.enums.WeChatAppStatusEnum;import com.kucaroom.mypicture.exception.WebApiException;import com.kucaroom.mypicture.exception.WebException;import com.kucaroom.mypicture.form.ShareForm;import com.kucaroom.mypicture.form.WeChatAppForm;import com.kucaroom.mypicture.responseObject.WeChatAppRes;import com.kucaroom.mypicture.service.QiNiuService;import com.kucaroom.mypicture.service.impl.WeChatAppServiceImpl;import com.kucaroom.mypicture.util.KeyUtil;import com.kucaroom.mypicture.util.ResponseData;import com.kucaroom.mypicture.util.ResponseUtil;import lombok.extern.slf4j.Slf4j;import net.sf.json.JSONObject;import org.springframework.beans.BeanUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.util.StringUtils;import org.springframework.validation.BindingResult;import org.springframework.web.bind.annotation.*;import org.springframework.web.servlet.ModelAndView;import javax.servlet.http.HttpServletRequest;import javax.validation.Valid;@Slf4j@Controller@RequestMapping("/admin/app")public class WeChatAppController {    @Autowired    private QiNiuService qiNiuService;    @Autowired    private WeChatAppServiceImpl weChatAppService;    @ResponseBody    @PostMapping("/edit")    public ResponseData<WeChatAppRes> editApp(HttpServletRequest request){        Integer appId = (Integer)request.getAttribute("appId");        String key = request.getParameter("name");        String value = request.getParameter("value");        log.info("参数：{}",request.getParameter("name"));        if(StringUtils.isEmpty(key)){            throw new WebApiException(ResponseEnum.PARAM_ERROR);        }        if(StringUtils.isEmpty(value)){            throw new WebApiException(ResponseEnum.PARAM_ERROR);        }        WeChatAppDTO weChatAppDTO = weChatAppService.edit(appId,key,value);        WeChatAppRes weChatAppRes = new WeChatAppRes();        BeanUtils.copyProperties(weChatAppDTO,weChatAppRes);        return ResponseUtil.success(weChatAppRes);    }    @ResponseBody    @PostMapping("/update_logo")    public ResponseData<WeChatAppRes> editLogo(@RequestBody JSONObject jsonObject,HttpServletRequest request){        Integer appId = (Integer)request.getAttribute("appId");        String value = (String) jsonObject.get("logo");        if(StringUtils.isEmpty(value)){            throw new WebApiException(ResponseEnum.PARAM_ERROR);        }        WeChatAppDTO weChatAppDTO = weChatAppService.edit(appId,"logo",value);        WeChatAppRes weChatAppRes = new WeChatAppRes();        BeanUtils.copyProperties(weChatAppDTO,weChatAppRes);        return ResponseUtil.success(weChatAppRes);    }    @GetMapping("/create")    public ModelAndView createAppView(){        return new ModelAndView("/admin/registerApp");    }    @ResponseBody    @PostMapping("/create")    public ResponseData<WeChatAppRes> createApp(@Valid WeChatAppForm appForm,                                                BindingResult bindingResult,                                                HttpServletRequest request){        Integer appId = (Integer)request.getAttribute("appId");        Integer adminId = (Integer)request.getAttribute("adminId");        if(bindingResult.hasErrors()){            throw new WebApiException(ResponseEnum.APP_CREATE_FAIL.getCode(),bindingResult.getFieldError().getDefaultMessage());        }        String token = weChatAppService.getAccessToken(appForm.getAppKey(),appForm.getAppSecret());        WeChatAppDTO weChatAppDTO = new WeChatAppDTO();        BeanUtils.copyProperties(appForm,weChatAppDTO);        weChatAppDTO.setAdminId(adminId);        weChatAppDTO.setAllianceKey(KeyUtil.generateKey(18));        weChatAppDTO.setDomain("https://weimei.qiuhuiyi.cn");        weChatAppDTO.setStatus(WeChatAppStatusEnum.AUDIT.getCode());        weChatAppDTO.setQrCode("");        WeChatAppDTO app = weChatAppService.create(weChatAppDTO);        WeChatAppRes weChatAppRes = new WeChatAppRes();        BeanUtils.copyProperties(weChatAppDTO,weChatAppRes);        //创建七牛账号        return ResponseUtil.success(weChatAppRes);    }    @ResponseBody    @GetMapping("/info")    public ResponseData<WeChatAppRes> appInfo(HttpServletRequest request){        Integer appId = (Integer)request.getAttribute("appId");        Integer adminId = (Integer)request.getAttribute("adminId");        WeChatAppDTO weChatAppDTO = weChatAppService.findByAdminId(adminId);        WeChatAppRes weChatAppRes = new WeChatAppRes();        BeanUtils.copyProperties(weChatAppDTO,weChatAppRes);        String domain = qiNiuService.domain(appId);        weChatAppRes.setQiNiuDomain(domain);        return ResponseUtil.success(weChatAppRes);    }    @ResponseBody    @PostMapping("/update_share_info")    public ResponseData<WeChatAppRes> updateShareInfo(@Valid ShareForm shareForm, HttpServletRequest request, BindingResult bindingResult){        Integer adminId = (Integer)request.getAttribute("adminId");        if(bindingResult.hasErrors()){            throw new WebException(ResponseEnum.PARAM_ERROR.getCode(),bindingResult.getFieldError().getDefaultMessage());        }        WeChatAppDTO weChatAppDTO = weChatAppService.findByAdminId(adminId);        weChatAppDTO.setShareImage(shareForm.getShareImage());        weChatAppDTO.setShareWord(shareForm.getShareWord());        WeChatAppDTO result = weChatAppService.updateShareInfo(weChatAppDTO);        WeChatAppRes  weChatAppRes = new WeChatAppRes();        BeanUtils.copyProperties(result,weChatAppRes);        return ResponseUtil.success(weChatAppRes);    }}