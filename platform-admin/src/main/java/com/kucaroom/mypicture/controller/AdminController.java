package com.kucaroom.mypicture.controller;import com.kucaroom.mypicture.DTO.PictureDTO;import com.kucaroom.mypicture.DTO.QiNiuAccountDTO;import com.kucaroom.mypicture.converter.PictureDTOPictureRes;import com.kucaroom.mypicture.converter.PictureFormToPictureDTO;import com.kucaroom.mypicture.enums.ResponseEnum;import com.kucaroom.mypicture.exception.WebApiException;import com.kucaroom.mypicture.form.PictureForm;import com.kucaroom.mypicture.responseObject.PictureRes;import com.kucaroom.mypicture.service.PictureService;import com.kucaroom.mypicture.service.QiNiuService;import com.kucaroom.mypicture.util.ResponseData;import com.kucaroom.mypicture.util.ResponseUtil;import lombok.extern.slf4j.Slf4j;import org.apache.shiro.SecurityUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.context.properties.bind.BindResult;import org.springframework.stereotype.Controller;import org.springframework.transaction.annotation.Transactional;import org.springframework.validation.BindingResult;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.PostMapping;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import org.springframework.web.servlet.ModelAndView;import javax.validation.Valid;import java.util.HashMap;import java.util.Map;@Slf4j@Controller@RequestMapping("/admin")public class AdminController {    @Autowired    private QiNiuService qiNiuService;    @Autowired    private PictureService pictureService;    /**     * 控制台主页     *     * @author yezi     * @return     */    @GetMapping("")    public ModelAndView index(){        log.info("登录用户：{}",SecurityUtils.getSubject().getPrincipal());        return new ModelAndView("/admin/index");    }    /**     * 控制台主界面     *     * @author yezi     * @return     */    @GetMapping("/dashboard")    public ModelAndView dashboard(){        return new ModelAndView("/admin/dashboard");    }    /**     * 上传图集界面     *     * @author yezi     * @return     */    @GetMapping("/upload")    public ModelAndView uploadPicture(){        return new ModelAndView("/admin/upload");    }    /**     * 上传图集     *     * @author yezi     * @param pictureForm     * @param bindingResult     * @return     */    @Transactional    @ResponseBody    @PostMapping("/upload")    public ResponseData upload(@Valid PictureForm pictureForm, BindingResult bindingResult){        if(bindingResult.hasErrors()){            throw new WebApiException(ResponseEnum.PICTURE_UPLOAD_ERROR.getCode(),bindingResult.getFieldError().getDefaultMessage());        }        PictureDTO pictureDTO = PictureFormToPictureDTO.convert(pictureForm);        pictureDTO.setAppId(74);        PictureDTO result = pictureService.create(pictureDTO);        if(result == null){            throw new WebApiException(ResponseEnum.PICTURE_CREATE_ERROR);        }        //装换数据格式        PictureRes response = PictureDTOPictureRes.convert(result);        return ResponseUtil.success(response);    }    /**     * 获取七牛token     *     * @author yezi     * @return     */    @ResponseBody    @GetMapping("/token")    public ResponseData uploadToken(){        String token = qiNiuService.getToken(74);        QiNiuAccountDTO qiNiuAccountDTO = qiNiuService.findByAppId(74);        if(qiNiuAccountDTO == null){            throw new WebApiException(ResponseEnum.QI_NIU_NOT_EXIST);        }        Map<String,String> map = new HashMap<>();        map.put("token",token);        map.put("domain",qiNiuAccountDTO.getUrl());        return ResponseUtil.success(map);    }}