package com.kucaroom.mypicture.service.impl;import com.kucaroom.mypicture.DTO.PictureDTO;import com.kucaroom.mypicture.converter.PictureToPictureDTO;import com.kucaroom.mypicture.domain.Picture;import com.kucaroom.mypicture.domain.PictureItem;import com.kucaroom.mypicture.enums.DownloadPictureTypeEnum;import com.kucaroom.mypicture.enums.PictureStatusEnum;import com.kucaroom.mypicture.enums.ResponseEnum;import com.kucaroom.mypicture.enums.ViewPictureTypeEnum;import com.kucaroom.mypicture.exception.WebApiException;import com.kucaroom.mypicture.mapper.PictureMapper;import com.kucaroom.mypicture.repository.PictureItemsRepository;import com.kucaroom.mypicture.repository.PictureRepository;import com.kucaroom.mypicture.service.DownloadPictureService;import com.kucaroom.mypicture.service.PictureItemsService;import com.kucaroom.mypicture.service.PictureService;import com.kucaroom.mypicture.service.ViewPictureLogService;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.BeanUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageImpl;import org.springframework.data.domain.Pageable;import org.springframework.data.jpa.domain.Specification;import org.springframework.stereotype.Service;import javax.persistence.criteria.CriteriaBuilder;import javax.persistence.criteria.CriteriaQuery;import javax.persistence.criteria.Predicate;import javax.persistence.criteria.Root;import javax.transaction.Transactional;import java.util.ArrayList;import java.util.List;import java.util.Optional;@Slf4j@Servicepublic class PictureServiceImpl implements PictureService {    @Autowired    private PictureRepository pictureRepository;    @Autowired    private PictureItemsRepository pictureItemsRepository;    @Autowired    private PictureItemsService pictureItemsService;    @Autowired    private PictureMapper pictureMapper;    @Autowired    private DownloadPictureService downloadPictureService;    @Autowired    private ViewPictureLogService viewPictureLogService;    /**     * 新建图集     *     * @author yezi     * @param pictureDTO     * @return     */    @Override    public PictureDTO create(PictureDTO pictureDTO){        Picture picture = new Picture();        BeanUtils.copyProperties(pictureDTO,picture);        picture.setStatus(PictureStatusEnum.PICTURE_DOWN.getCode());        Picture pictureResult = pictureRepository.save(picture);        if(pictureResult == null){            throw new WebApiException(ResponseEnum.PICTURE_CREATE_ERROR);        }        List<PictureItem> pictureItemList = new ArrayList<>();        for (PictureItem pictureItem:pictureDTO.getPictureItems()){            pictureItem.setPictureId(pictureResult.getId());            pictureItemList.add(pictureItem);        }        List<PictureItem> pictureItemResults = pictureItemsRepository.saveAll(pictureItemList);        if(pictureItemResults.size() != pictureDTO.getPictureItems().size()){            throw new WebApiException(ResponseEnum.PICTURE_CREATE_ERROR);        }        BeanUtils.copyProperties(picture,pictureDTO);        pictureDTO.setPictureItems(pictureItemResults);        return pictureDTO;    }    /**     * 根据图集状态获取分页列表     *     * @author yezi     * @param pageable     * @param appId     * @param status     * @return     */    @Override    public Page<PictureDTO> findByStatus(Pageable pageable,Integer appId, Integer status) {        Specification<Picture> pictureSpecification = new Specification<Picture>() {            @Override            public Predicate toPredicate(Root<Picture> root, CriteriaQuery<?> criteriaQuery, CriteriaBuilder criteriaBuilder) {                List<Predicate> predicateList = new ArrayList<>();                predicateList.add(criteriaBuilder.equal(root.get("status"),status));                predicateList.add(criteriaBuilder.equal(root.get("appId"),appId));                return criteriaBuilder.and(predicateList.toArray(new Predicate[predicateList.size()]));            }        };        Page<Picture> picturePage = pictureRepository.findAll(pictureSpecification,pageable);        //数据转化        List<PictureDTO> pictureList = PictureToPictureDTO.convert(picturePage.getContent());        Page<PictureDTO> pictureDTOS = new PageImpl<PictureDTO>(pictureList,pageable,picturePage.getTotalElements());        return pictureDTOS;    }    /**     * 获取单个图集     *     * @author yezi     * @param id     * @return     */    @Override    public PictureDTO findById(Integer id) {        Optional<Picture> pictureOP = pictureRepository.findById(id);        if(!pictureOP.isPresent()){            throw new WebApiException(ResponseEnum.PICTURE_NOT_EXIST);        }        Picture picture = pictureOP.get();        PictureDTO pictureDTO = new PictureDTO();        BeanUtils.copyProperties(picture,pictureDTO);        return pictureDTO;    }    /**     * 获取图集的分页列表信息     *     * @author yezi     * @param pageable     * @param appId     * @return     */    @Override    public Page<PictureDTO> findByAppId(Pageable pageable,Integer appId) {        Specification<Picture> specification = new Specification<Picture>() {            //测试            @Override            public Predicate toPredicate(Root<Picture> root, CriteriaQuery<?> criteriaQuery, CriteriaBuilder criteriaBuilder) {                List<Predicate> predicateList = new ArrayList<>();                predicateList.add(criteriaBuilder.equal(root.get("appId"),appId));                return criteriaBuilder.and(predicateList.toArray(new Predicate[predicateList.size()]));            }        };        Page<Picture> picturePage = pictureRepository.findAll(specification,pageable);        List<PictureDTO> pictureList = PictureToPictureDTO.convert(picturePage.getContent());        Page<PictureDTO> pictureDTOS = new PageImpl<PictureDTO>(pictureList,pageable,picturePage.getTotalElements());        return pictureDTOS;    }    @Override    @Transactional    public Integer deleteById(Integer appId, Integer pictureId) {        PictureDTO pictureDTO = this.findById(pictureId);        if(pictureDTO.getAppId() != appId){            throw new WebApiException(ResponseEnum.NOT_AUTH);        }        Integer deleteResult = pictureMapper.deleteByIdAndAppId(pictureId,appId);        if(deleteResult <= 0){            throw new WebApiException(ResponseEnum.PICTURE_DELETE_FAIL);        }        //删除图片        pictureItemsService.deleteByPictureId(pictureId);        //删除下载记录        downloadPictureService.deleteByPictureItemIdAndType(pictureId,DownloadPictureTypeEnum.PICTURE.getCode());        //删除浏览记录        viewPictureLogService.deleteByPictureIdAndType(pictureId,ViewPictureTypeEnum.PICTURE.getCode());        return deleteResult;    }    /**     * 修改图集状态     *     * @author yezi     * @param appId     * @param pictureId     * @param status     * @return     */    @Override    public Picture updateStatus(Integer appId, Integer pictureId,Integer status) {        Optional<Picture> pictureOptional = pictureRepository.findById(pictureId);        if(!pictureOptional.isPresent()){            throw new WebApiException(ResponseEnum.PICTURE_NOT_EXIST);        }        Picture picture = pictureOptional.get();        if(picture.getAppId() != appId){            throw new WebApiException(ResponseEnum.NOT_AUTH);        }        if(status != PictureStatusEnum.PICTURE_DOWN.getCode() && status != PictureStatusEnum.PICTURE_UP.getCode()){            throw new WebApiException(ResponseEnum.PARAM_ERROR);        }        picture.setStatus(status);        pictureRepository.save(picture);        return picture;    }}